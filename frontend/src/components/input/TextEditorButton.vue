<script lang="ts" setup>
import { onMounted, onUnmounted, ref } from "vue"
import type { Component } from "vue"
import IconDropdown from "~icons/ic/baseline-arrow-drop-down"

const props = defineProps<EditorButton>()

const emits = defineEmits<{
  toggle: [value: EditorButton]
}>()

const showDropdown = ref(false)

function onClickToggle(button: EditorButton) {
  if (!button.childButtons || button.type === "more") emits("toggle", button)
  else if (button.type === "menu") showDropdown.value = !showDropdown.value
}

const closeDropDownWhenClickOutSide = (event: MouseEvent) => {
  if (props.type) {
    const button = document.querySelector(`#${props.type}`)
    if (button == null) return
    if ((event.target as HTMLElement) === button) return
    if ((event.target as HTMLElement).id === "menu") return
    showDropdown.value = false
  }
}

onMounted(() => {
  document.addEventListener("click", closeDropDownWhenClickOutSide)
})
onUnmounted(() => {
  document.removeEventListener("click", closeDropDownWhenClickOutSide)
})

export interface EditorButton {
  type: string
  icon: Component
  ariaLabel: string
  childButtons?: EditorButton[]
  isLast?: boolean
  isActive?: boolean
  isCollapsable?: boolean
  disabled?: boolean
  group?: string
  callback?: () => void
}
</script>

<template>
  <div>
    <div class="flex flex-row">
      <button
        :aria-label="ariaLabel"
        class="flex cursor-pointer p-8 text-blue-800 hover:bg-blue-200 disabled:bg-transparent disabled:text-gray-600"
        :class="{
          'bg-blue-200': isActive && !childButtons,
        }"
        :disabled="disabled"
        @click="onClickToggle(props)"
        @keydown.m="onClickToggle(props)"
        @mousedown.prevent=""
      >
        <component :is="icon" />
        <IconDropdown v-if="type === 'menu'" class="-mr-8" />
      </button>
      <div
        v-if="isLast"
        class="ml-8 mr-8 h-24 w-1 self-center bg-blue-300"
      ></div>
    </div>
    <div
      v-if="showDropdown"
      class="absolute z-50 mt-1 flex flex-row items-center border-1 border-solid border-blue-800 bg-white"
    >
      <button
        v-for="(childButton, index) in childButtons"
        :key="index"
        :aria-label="childButton.ariaLabel"
        class="hover:bg-blue-20 z-50 cursor-pointer items-center p-8 text-blue-900 disabled:bg-transparent disabled:text-gray-600"
        :class="{
          'bg-blue-200': isActive,
        }"
        :disabled="disabled"
        @click="emits('toggle', childButton)"
        @keydown.m="emits('toggle', childButton)"
        @mousedown.prevent=""
      >
        <component :is="childButton.icon" />
      </button>
    </div>
  </div>
</template>
